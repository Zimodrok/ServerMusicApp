<template>
  <div
    v-if="player.state.queue.length"
    class="fixed bottom-0 left-0 right-0 z-40 bg-stone-900/95 border-t border-stone-700 text-zinc-100 px-10 py-2 grid grid-cols-[1.2fr,1fr,1.2fr] gap-4 items-center"
  >
    <div class="flex items-center gap-3 min-w-0 max-w-[35rem] flex-1">
      <div class="relative">
        <img
          v-if="currentTrack && currentTrack.cover"
          :src="currentTrack.cover"
          alt=""
          class="w-12 h-12 rounded-md object-cover transition"
        />
        <button
          v-if="currentTrack && currentTrack.cover"
          class="absolute inset-0 flex items-center justify-center text-white bg-black/40 opacity-0 hover:opacity-100 transition rounded-md text-xl"
          title="Maximize player"
          @click="expanded = true"
        >
          ⤢
        </button>
      </div>
      <div class="min-w-0">
        <p class="font-medium truncate">
          {{ currentTrack ? currentTrack.title : "Nothing playing" }}
        </p>
        <p class="text-xs text-zinc-400 truncate">
          <span v-if="currentTrack?.artist">{{ currentTrack.artist }}</span>
          <span v-if="currentTrack?.album"> • {{ currentTrack.album }} </span>
        </p>
      </div>
    </div>

    <div class="flex flex-col items-center gap-1 max-w-md justify-self-center">
      <div class="flex items-center gap-2">
        <button
          class="flex items-center justify-center w-10 h-10 text-zinc-400 hover:text-white"
          @click="player.toggleShuffle"
          :title="player.state.isShuffle ? 'Shuffle on' : 'Shuffle off'"
        >
          <svg class="w-8 h-8 fill-white">
            <g
              transform="scale(0.75) translate(0, 10)"
              :class="player.state.isShuffle ? 'invisible' : ' visible'"
            >
              <path
                d="M12.7148 25.4395C19.7363 25.4395 25.4395 19.7461 25.4395 12.7246C25.4395 5.70312 19.7363 0 12.7148 0C5.69336 0 0 5.70312 0 12.7246C0 19.7461 5.69336 25.4395 12.7148 25.4395ZM12.7148 23.623C6.68945 23.623 1.81641 18.75 1.81641 12.7246C1.81641 6.69922 6.68945 1.82617 12.7148 1.82617C18.7402 1.82617 23.6133 6.69922 23.6133 12.7246C23.6133 18.75 18.7402 23.623 12.7148 23.623Z"
                fill-opacity="0.85"
              />
              <path
                d="M16.6211 7.1875L16.6211 11.3281C16.6211 11.6699 16.8359 11.8945 17.1582 11.8945C17.3242 11.8945 17.4805 11.8262 17.5977 11.7285L20.0977 9.70703C20.3809 9.47266 20.3906 9.0625 20.1074 8.82812L17.5879 6.77734C17.4707 6.67969 17.3145 6.63086 17.1582 6.63086C16.8262 6.63086 16.6211 6.8457 16.6211 7.1875ZM17.0898 9.9707C17.4512 9.9707 17.7441 9.67773 17.7441 9.31641C17.7441 8.95508 17.4512 8.66211 17.0898 8.66211L15.459 8.66211C14.3457 8.66211 13.6621 8.99414 12.8418 9.94141L8.89648 14.5801C8.33008 15.2539 7.90039 15.4785 7.23633 15.4785L5.69336 15.4785C5.30273 15.4785 5 15.7617 5 16.1328C5 16.5137 5.2832 16.7871 5.69336 16.7871L7.2168 16.7871C8.33008 16.7871 9.01367 16.4551 9.83398 15.5078L13.7891 10.8691C14.3457 10.2051 14.7559 9.9707 15.498 9.9707ZM16.6309 18.3105C16.6309 18.6523 16.8359 18.8672 17.168 18.8672C17.3242 18.8672 17.4805 18.8184 17.5977 18.7207L20.1172 16.6699C20.4004 16.4355 20.3906 16.0254 20.1074 15.791L17.6074 13.7793C17.4902 13.6719 17.334 13.6035 17.168 13.6035C16.8457 13.6035 16.6309 13.8281 16.6309 14.1699ZM17.0996 15.5273L15.5078 15.5273C14.7656 15.5273 14.3555 15.293 13.7988 14.6289L9.84375 9.99023C9.02344 9.04297 8.33984 8.71094 7.22656 8.71094L5.70312 8.71094C5.29297 8.71094 5.00977 8.98438 5.00977 9.36523C5.00977 9.73633 5.3125 10.0195 5.70312 10.0195L7.24609 10.0195C7.91016 10.0195 8.33984 10.2441 8.90625 10.918L12.8516 15.5566C13.6719 16.5039 14.3555 16.8359 15.4688 16.8359L17.0996 16.8359C17.4609 16.8359 17.7539 16.543 17.7539 16.1816C17.7539 15.8203 17.4609 15.5273 17.0996 15.5273Z"
                fill-opacity="0.85"
              />
            </g>
            <g
              transform="scale(0.75) translate(0, 10)"
              :class="player.state.isShuffle ? 'visible' : ' invisible'"
            >
              <path
                d="M25.4395 12.7246C25.4395 19.7266 19.7266 25.4395 12.7148 25.4395C5.71289 25.4395 0 19.7266 0 12.7246C0 5.71289 5.71289 0 12.7148 0C19.7266 0 25.4395 5.71289 25.4395 12.7246ZM16.7285 7.05078L16.7285 8.55469L15.5371 8.55469C14.3945 8.55469 13.6914 8.89648 12.8516 9.87305L11.2994 11.6952L9.78516 9.92188C8.94531 8.94531 8.24219 8.61328 7.09961 8.61328L5.54688 8.61328C5.11719 8.61328 4.82422 8.89648 4.82422 9.28711C4.82422 9.66797 5.13672 9.96094 5.54688 9.96094L7.12891 9.96094C7.80273 9.96094 8.23242 10.1855 8.81836 10.8789L10.4065 12.7433L8.80859 14.6191C8.22266 15.3125 7.79297 15.5371 7.10938 15.5371L5.53711 15.5371C5.12695 15.5371 4.81445 15.8301 4.81445 16.2109C4.81445 16.6016 5.10742 16.8848 5.53711 16.8848L7.08984 16.8848C8.23242 16.8848 8.93555 16.543 9.77539 15.5762L11.2994 13.7914L12.8613 15.625C13.7012 16.6016 14.4043 16.9434 15.5469 16.9434L16.7383 16.9434L16.7383 18.457C16.7383 18.7988 16.9531 19.0137 17.2852 19.0137C17.4512 19.0137 17.6074 18.9648 17.7344 18.8672L20.3223 16.7676C20.6055 16.5234 20.5957 16.1035 20.3125 15.8594L17.7441 13.7988C17.6172 13.6914 17.4609 13.623 17.2852 13.623C16.9629 13.623 16.7383 13.8477 16.7383 14.1992L16.7383 15.5859L15.5859 15.5859C14.8242 15.5859 14.4043 15.3516 13.8379 14.668L12.1944 12.7433L13.8281 10.8301C14.3945 10.1465 14.8145 9.91211 15.5762 9.91211L16.7285 9.91211L16.7285 11.2988C16.7285 11.6504 16.9531 11.875 17.2754 11.875C17.4512 11.875 17.6074 11.8066 17.7344 11.6992L20.293 9.63867C20.5859 9.39453 20.5957 8.97461 20.3125 8.73047L17.7246 6.63086C17.5977 6.5332 17.4414 6.48438 17.2754 6.48438C16.9434 6.48438 16.7285 6.69922 16.7285 7.05078Z"
                fill-opacity="0.85"
              />
            </g>
          </svg>
        </button>

        <button
          class="flex items-center justify-center w-10 h-10 text-zinc-200 hover:text-white"
          @click="player.playPrev"
          title="Previous"
        >
          <svg class="w-8 h-8 fill-white">
            <g transform="scale(0.55) translate(0, 20)">
              <path
                d="M39.3555 17.3633L39.3555 1.60156C39.3555 0.507812 38.7109 0 37.9688 0C37.6367 0 37.3047 0.0976562 36.9727 0.283203L23.7402 8.04688C22.9102 8.52539 22.5781 8.90625 22.5781 9.48242C22.5781 10.0586 22.9102 10.4297 23.7402 10.9082L36.9727 18.6719C37.3047 18.8574 37.6367 18.9551 37.9688 18.9551C38.7109 18.9551 39.3555 18.457 39.3555 17.3633ZM22.6465 17.3633L22.6465 1.60156C22.6465 0.507812 22.002 0 21.2598 0C20.9277 0 20.5957 0.0976562 20.2637 0.283203L7.04102 8.04688C6.21094 8.52539 5.86914 8.90625 5.86914 9.48242C5.86914 10.0586 6.21094 10.4297 7.04102 10.9082L20.2637 18.6719C20.5957 18.8574 20.9277 18.9551 21.2598 18.9551C22.002 18.9551 22.6465 18.457 22.6465 17.3633ZM4.375 18.8965C5.41992 18.8965 5.9375 18.3789 5.9375 17.334L5.9375 1.61133C5.9375 0.576172 5.41992 0.0488281 4.375 0.0488281L1.5625 0.0488281C0.517578 0.0488281 0 0.527344 0 1.61133L0 17.334C0 18.3789 0.517578 18.8965 1.5625 18.8965Z"
                fill-opacity="0.85"
              />
            </g>
          </svg>
        </button>

        <button
          class="bg-zinc-100 text-zinc-900 rounded-full h-10 w-10 flex items-center justify-center"
          @click="player.togglePlay"
          title="Play / Pause"
        >
          <span v-if="!player.state.isPlaying">
            <svg class="w-8 h-8 fill-black">
              <g
                transform="scale(0.75) translate(11, 11)"
                :class="player.state.isRepeatOne ? 'invisible' : ' visible'"
              >
                <path
                  d="M2.25586 19.1699C2.25586 20.3223 2.92969 20.8594 3.7207 20.8594C4.0625 20.8594 4.42383 20.752 4.76562 20.5566L19.4531 11.9238C20.3613 11.3965 20.6934 11.0254 20.6934 10.4297C20.6934 9.82422 20.3613 9.45312 19.4531 8.92578L4.76562 0.292969C4.42383 0.0976562 4.0625 0 3.7207 0C2.92969 0 2.25586 0.527344 2.25586 1.67969Z"
                  fill-opacity="0.85"
                />
              </g>
            </svg>
          </span>
          <span v-else>
            <svg class="w-8 h-8 fill-black">
              <g
                transform="scale(0.75) translate(14, 11)"
                :class="player.state.isRepeatOne ? 'invisible' : ' visible'"
              >
                <path
                  d="M1.5625 20.5371L4.375 20.5371C5.41992 20.5371 5.9375 20.0195 5.9375 18.9746L5.9375 1.5625C5.9375 0.478516 5.41992 0 4.375 0L1.5625 0C0.517578 0 0 0.517578 0 1.5625L0 18.9746C0 20.0195 0.517578 20.5371 1.5625 20.5371ZM10.459 20.5371L13.2715 20.5371C14.3164 20.5371 14.834 20.0195 14.834 18.9746L14.834 1.5625C14.834 0.478516 14.3164 0 13.2715 0L10.459 0C9.41406 0 8.89648 0.517578 8.89648 1.5625L8.89648 18.9746C8.89648 20.0195 9.41406 20.5371 10.459 20.5371Z"
                  fill-opacity="0.85"
                />
              </g>
            </svg>
          </span>
        </button>

        <button
          class="flex items-center justify-center w-10 h-10 text-zinc-200 hover:text-white"
          @click="player.playNext"
          title="Next"
        >
          <svg class="w-8 h-8 fill-white">
            <g transform="scale(0.55) translate(0, 20)">
              <path
                d="M0 17.3633C0 18.457 0.644531 18.9551 1.38672 18.9551C1.71875 18.9551 2.05078 18.8574 2.37305 18.6719L15.6055 10.9082C16.4355 10.4297 16.7676 10.0586 16.7676 9.48242C16.7676 8.90625 16.4355 8.52539 15.6055 8.04688L2.37305 0.283203C2.05078 0.0976562 1.71875 0 1.38672 0C0.644531 0 0 0.507812 0 1.60156ZM16.709 17.3633C16.709 18.457 17.3438 18.9551 18.0957 18.9551C18.418 18.9551 18.7598 18.8574 19.082 18.6719L32.3145 10.9082C33.1445 10.4297 33.4766 10.0586 33.4766 9.48242C33.4766 8.90625 33.1445 8.52539 32.3145 8.04688L19.082 0.283203C18.7598 0.0976562 18.418 0 18.0957 0C17.3438 0 16.709 0.507812 16.709 1.60156ZM34.9805 18.8965L37.793 18.8965C38.8281 18.8965 39.3555 18.3789 39.3555 17.334L39.3555 1.61133C39.3555 0.527344 38.8281 0.0488281 37.793 0.0488281L34.9805 0.0488281C33.9355 0.0488281 33.418 0.576172 33.418 1.61133L33.418 17.334C33.418 18.3789 33.9355 18.8965 34.9805 18.8965Z"
                fill-opacity="0.85"
              />
            </g>
          </svg>
        </button>

        <button
          class="flex items-center justify-center w-10 h-10 text-zinc-400 hover:text-white"
          @click="player.toggleRepeatOne"
          :title="player.state.isRepeatOne ? 'Repeat one on' : 'Repeat off'"
        >
          <svg class="w-8 h-8 fill-white">
            <g
              transform="scale(0.75) translate(0, 10)"
              :class="player.state.isRepeatOne ? 'invisible' : ' visible'"
            >
              <path
                d="M12.7148 25.4395C19.7363 25.4395 25.4395 19.7461 25.4395 12.7246C25.4395 5.70312 19.7363 0 12.7148 0C5.69336 0 0 5.70312 0 12.7246C0 19.7461 5.69336 25.4395 12.7148 25.4395ZM12.7148 23.623C6.68945 23.623 1.81641 18.75 1.81641 12.7246C1.81641 6.69922 6.68945 1.82617 12.7148 1.82617C18.7402 1.82617 23.6133 6.69922 23.6133 12.7246C23.6133 18.75 18.7402 23.623 12.7148 23.623Z"
                fill-opacity="0.85"
              />
              <path
                d="M13.6035 6.5625L13.6035 11.2695C13.6035 11.6406 13.8379 11.875 14.1992 11.875C14.3555 11.875 14.5312 11.8262 14.668 11.6992L17.5 9.4043C17.8223 9.14062 17.8223 8.71094 17.5 8.4375L14.668 6.13281C14.5312 6.01562 14.3555 5.95703 14.1992 5.95703C13.8379 5.95703 13.6035 6.19141 13.6035 6.5625ZM14.5703 9.6582C14.9609 9.6582 15.293 9.32617 15.293 8.92578C15.293 8.53516 14.9609 8.20312 14.5703 8.20312L8.73047 8.20312C6.47461 8.20312 4.99023 9.57031 4.99023 11.6602L4.99023 12.373C4.99023 12.7832 5.32227 13.1055 5.73242 13.1055C6.14258 13.1055 6.47461 12.7832 6.47461 12.373L6.47461 11.7285C6.47461 10.4785 7.34375 9.6582 8.63281 9.6582ZM11.8457 18.9355L11.8457 14.2285C11.8457 13.8574 11.6113 13.623 11.25 13.623C11.0938 13.623 10.918 13.6719 10.7812 13.7988L7.94922 16.0938C7.62695 16.3574 7.62695 16.7871 7.94922 17.0605L10.7812 19.3652C10.918 19.4824 11.0938 19.541 11.25 19.541C11.6113 19.541 11.8457 19.3066 11.8457 18.9355ZM10.8789 15.8398C10.4883 15.8398 10.1562 16.1719 10.1562 16.5723C10.1562 16.9629 10.4883 17.2949 10.8789 17.2949L16.7188 17.2949C18.9746 17.2949 20.4492 15.9277 20.4492 13.8379L20.4492 13.125C20.4492 12.7148 20.127 12.3926 19.7168 12.3926C19.2969 12.3926 18.9746 12.7148 18.9746 13.125L18.9746 13.7695C18.9746 15.0098 18.1055 15.8398 16.8164 15.8398Z"
                fill-opacity="0.85"
              />
            </g>
            <g
              transform="scale(0.75) translate(0, 10)"
              :class="player.state.isRepeatOne ? 'visible' : ' invisible'"
            >
              <path
                d="M25.4395 12.7246C25.4395 19.7266 19.7266 25.4395 12.7148 25.4395C5.71289 25.4395 0 19.7266 0 12.7246C0 5.71289 5.71289 0 12.7148 0C19.7266 0 25.4395 5.71289 25.4395 12.7246ZM19.1309 13.1348L19.1309 13.7988C19.1309 15.0781 18.2422 15.9082 16.9336 15.9082L11.8359 15.9082L11.8359 14.2676C11.8359 13.877 11.6016 13.6426 11.2207 13.6426C11.0645 13.6426 10.8789 13.6914 10.7422 13.8184L7.8418 16.1719C7.50977 16.4453 7.50977 16.8848 7.8418 17.168L10.7422 19.5312C10.8789 19.668 11.0645 19.7168 11.2207 19.7168C11.6016 19.7168 11.8359 19.4727 11.8359 19.0918L11.8359 17.4121L16.8262 17.4121C19.1406 17.4121 20.6641 16.0156 20.6641 13.8672L20.6641 13.1348C20.6641 12.7148 20.3223 12.3828 19.9023 12.3828C19.4727 12.3828 19.1309 12.7148 19.1309 13.1348ZM13.6328 6.40625L13.6328 8.08594L8.64258 8.08594C6.32812 8.08594 4.80469 9.48242 4.80469 11.6309L4.80469 12.3633C4.80469 12.7832 5.14648 13.1152 5.55664 13.1152C5.99609 13.1152 6.33789 12.7832 6.33789 12.3633L6.33789 11.6992C6.33789 10.4199 7.2168 9.58008 8.53516 9.58008L13.6328 9.58008L13.6328 11.2305C13.6328 11.6211 13.8672 11.8555 14.248 11.8555C14.4043 11.8555 14.5898 11.7969 14.7266 11.6797L17.627 9.32617C17.959 9.05273 17.959 8.60352 17.627 8.33008L14.7266 5.9668C14.5898 5.83008 14.4043 5.78125 14.248 5.78125C13.8672 5.78125 13.6328 6.02539 13.6328 6.40625Z"
                fill-opacity="0.85"
              />
            </g>
          </svg>
        </button>
      </div>

      <!-- Прогрес -->
      <div class="flex items-center gap-2 w-full">
        <span class="text-sm text-zinc-400 w-9 text-right">
          {{ currentTimeLabel }}
        </span>
        <input
          type="range"
          min="0"
          max="100"
          v-model.number="progress"
          @input="onSeek"
          class="w-full range-slim"
          :style="{ '--pct': progress + '%' }"
        />
        <span class="text-sm text-zinc-400 w-9">
          {{ durationLabel }}
        </span>
      </div>
    </div>

    <div class="flex items-center gap-3 justify-self-end">
      <button
        class="text-zinc-300 hover:text-white"
        @click="showQueue = !showQueue"
        title="Queue & history"
      >
        ☰
      </button>

      <div class="flex items-center gap-1 w-28">
        <svg class="w-8 h-8 fill-white">
          <g transform="scale(0.55) translate(0, 19)">
            <path
              d="M28.4863 24.0882C28.8672 24.3616 29.3848 24.2542 29.6777 23.8245C31.8359 20.6116 33.2324 16.6858 33.2324 12.1253C33.2324 7.55495 31.8066 3.63894 29.6777 0.41628C29.3848-0.0231731 28.8672-0.120829 28.4863 0.152608C28.0859 0.426046 28.0273 0.943624 28.3301 1.38308C30.2734 4.3323 31.582 7.90651 31.582 12.1253C31.582 16.3342 30.2734 19.9182 28.3301 22.8577C28.0273 23.2971 28.0859 23.8147 28.4863 24.0882Z"
              fill-opacity="0.85"
            />
            <path
              d="M23.916 20.7385C24.3164 21.012 24.8145 20.9241 25.0977 20.5139C26.7188 18.3264 27.6855 15.2503 27.6855 12.1253C27.6855 8.9905 26.7285 5.8948 25.0977 3.73659C24.8145 3.32644 24.3164 3.22878 23.916 3.50222C23.5254 3.77566 23.457 4.2737 23.7695 4.72292C25.2051 6.71511 26.0156 9.36159 26.0156 12.1253C26.0156 14.8889 25.1855 17.5257 23.7695 19.5276C23.4668 19.9671 23.5254 20.4749 23.916 20.7385Z"
              fill-opacity="0.85"
            />
            <path
              d="M19.3945 17.4475C19.7656 17.7014 20.2734 17.6135 20.5566 17.2034C21.5234 15.9339 22.1289 14.0882 22.1289 12.1253C22.1289 10.1526 21.5234 8.31667 20.5566 7.03737C20.2734 6.62722 19.7656 6.54909 19.3945 6.803C18.9648 7.10573 18.8965 7.63308 19.2285 8.0823C20.0293 9.17605 20.459 10.5725 20.459 12.1253C20.459 13.6682 20.0195 15.055 19.2285 16.1682C18.9062 16.6175 18.9648 17.135 19.3945 17.4475Z"
              fill-opacity="0.85"
            />
            <path
              d="M13.4668 23.1018C14.2285 23.1018 14.7461 22.5452 14.7461 21.803L14.7461 2.51589C14.7461 1.7737 14.2285 1.16823 13.4473 1.16823C12.9102 1.16823 12.5391 1.40261 11.9824 1.92995L6.52344 7.10573C6.43555 7.19362 6.31836 7.23269 6.17188 7.23269L2.4707 7.23269C0.908203 7.23269 0 8.14089 0 9.80105L0 14.5276C0 16.178 0.908203 17.0862 2.4707 17.0862L6.17188 17.0862C6.31836 17.0862 6.43555 17.135 6.52344 17.2229L11.9824 22.3889C12.4902 22.8675 12.9297 23.1018 13.4668 23.1018Z"
              fill-opacity="0.85"
            />
          </g>
        </svg>
        <input
          type="range"
          min="0"
          max="1"
          step="0.01"
          v-model.number="volume"
          @input="onVolume"
          class="w-full range-slim"
          :style="{ '--pct': volume * 100 + '%' }"
        />
      </div>
    </div>

    <audio
      ref="audioRef"
      class="hidden"
      crossorigin="use-credentials"
      @timeupdate="onTimeUpdate"
      @ended="player.onTrackEnded"
    ></audio>

    <div
      v-if="showQueue"
      class="fixed bottom-14 right-4 z-50 w-80 max-h-[70vh] bg-stone-900 border border-stone-700 rounded-lg shadow-xl text-sm flex flex-col"
    >
      <div
        class="flex items-center justify-between px-3 py-2 border-b border-stone-700"
      >
        <span class="font-semibold">History</span>
        <button
          class="text-xs text-zinc-400 hover:text-zinc-100"
          @click="player.clearQueue"
        >
          Clear queue
        </button>
      </div>
      <div
        class="max-h-32 overflow-y-auto space-y-1 border-b border-stone-800 px-3 py-2"
      >
        <div
          v-for="(t, idx) in player.state.history"
          :key="'h-' + t.id + '-' + idx"
          class="flex items-center justify-between gap-2 text-zinc-300"
        >
          <p class="truncate">
            {{ t.title }}
          </p>
          <button
            class="text-[11px] text-zinc-400 hover:text-zinc-100"
            @click="player.playNow(t)"
          >
            Play
          </button>
        </div>
        <p v-if="!player.state.history.length" class="text-zinc-500 text-xs">
          No history yet
        </p>
      </div>

      <div
        class="flex items-center justify-between px-3 py-2 border-b border-stone-700"
      >
        <span class="font-semibold">Up Next</span>
      </div>

      <div class="overflow-y-auto max-h-48 divide-y divide-stone-800">
        <div
          v-for="(t, idx) in player.state.queue"
          :key="t.id + '-' + idx"
          class="px-3 py-2 flex items-center gap-2 hover:bg-stone-800 cursor-pointer"
          :class="{
            'bg-stone-800': idx === player.state.currentIndex,
          }"
          @click="jumpTo(idx)"
        >
          <span class="text-[10px] text-zinc-500 w-4">
            {{ idx === player.state.currentIndex ? "▶" : idx + 1 }}
          </span>
          <div class="min-w-0">
            <p class="truncate">{{ t.title }}</p>
            <p class="truncate text-[11px] text-zinc-400">
              {{ t.artist }} • {{ t.album }}
            </p>
          </div>
        </div>
        <p v-if="!player.state.queue.length" class="px-3 py-2 text-zinc-500">
          Queue is empty
        </p>
      </div>
    </div>
  </div>

  <!-- Expanded player -->
  <div
    v-if="expanded"
    class="fixed inset-0 z-50 bg-black/75 backdrop-blur-md flex items-center justify-center p-8"
    @click.self="expanded = false"
  >
    <div
      class="bg-stone-900/95 text-white rounded-3xl shadow-2xl p-6 max-w-6xl w-[78vw] h-[78vh] relative overflow-hidden flex flex-col xl:grid xl:grid-cols-[minmax(0,1fr)_360px] gap-6 overflow-y-auto no-scrollbar"
    >
      <div
        class="absolute inset-0 blur-3xl opacity-50 scale-110"
        :style="{
          backgroundImage: currentTrack?.cover
            ? `url(${currentTrack.cover})`
            : '',
          backgroundSize: 'cover',
          backgroundPosition: 'center',
        }"
      ></div>
      <div
        class="absolute inset-0 smoke-layer mix-blend-screen opacity-60"
      ></div>
      <div
        class="absolute inset-0 smoke-plume smoke-plume-1 mix-blend-screen"
      ></div>
      <div
        class="absolute inset-0 smoke-plume smoke-plume-2 mix-blend-screen"
      ></div>
      <div
        class="absolute inset-0 smoke-plume smoke-plume-3 mix-blend-screen"
      ></div>
      <div
        class="absolute inset-0 bg-gradient-to-br from-black/50 via-transparent to-black/60 opacity-80 pointer-events-none"
      ></div>
      <div class="relative z-10 flex flex-col items-center gap-5 w-full">
        <img
          :src="currentTrack?.cover"
          alt=""
          class="w-full max-w-[520px] aspect-square object-cover rounded-2xl shadow-2xl"
        />
        <div class="text-center space-y-1 px-4 max-w-3xl">
          <p class="text-3xl font-semibold truncate">
            {{ currentTrack?.title }}
          </p>
          <p class="text-lg text-zinc-300 truncate">
            {{ currentTrack?.artist }}
            <span v-if="currentTrack?.album"> • {{ currentTrack?.album }}</span>
          </p>
        </div>
        <div class="flex items-center justify-center gap-5">
          <button
            class="text-zinc-400 hover:text-white text-lg"
            @click="player.toggleShuffle"
            :title="player.state.isShuffle ? 'Shuffle on' : 'Shuffle off'"
          >
            <svg class="w-8 h-8 fill-white">
              <g
                transform="scale(0.75) translate(0, 10)"
                :class="player.state.isShuffle ? 'invisible' : ' visible'"
              >
                <path
                  d="M12.7148 25.4395C19.7363 25.4395 25.4395 19.7461 25.4395 12.7246C25.4395 5.70312 19.7363 0 12.7148 0C5.69336 0 0 5.70312 0 12.7246C0 19.7461 5.69336 25.4395 12.7148 25.4395ZM12.7148 23.623C6.68945 23.623 1.81641 18.75 1.81641 12.7246C1.81641 6.69922 6.68945 1.82617 12.7148 1.82617C18.7402 1.82617 23.6133 6.69922 23.6133 12.7246C23.6133 18.75 18.7402 23.623 12.7148 23.623Z"
                  fill-opacity="0.85"
                />
                <path
                  d="M16.6211 7.1875L16.6211 11.3281C16.6211 11.6699 16.8359 11.8945 17.1582 11.8945C17.3242 11.8945 17.4805 11.8262 17.5977 11.7285L20.0977 9.70703C20.3809 9.47266 20.3906 9.0625 20.1074 8.82812L17.5879 6.77734C17.4707 6.67969 17.3145 6.63086 17.1582 6.63086C16.8262 6.63086 16.6211 6.8457 16.6211 7.1875ZM17.0898 9.9707C17.4512 9.9707 17.7441 9.67773 17.7441 9.31641C17.7441 8.95508 17.4512 8.66211 17.0898 8.66211L15.459 8.66211C14.3457 8.66211 13.6621 8.99414 12.8418 9.94141L8.89648 14.5801C8.33008 15.2539 7.90039 15.4785 7.23633 15.4785L5.69336 15.4785C5.30273 15.4785 5 15.7617 5 16.1328C5 16.5137 5.2832 16.7871 5.69336 16.7871L7.2168 16.7871C8.33008 16.7871 9.01367 16.4551 9.83398 15.5078L13.7891 10.8691C14.3457 10.2051 14.7559 9.9707 15.498 9.9707ZM16.6309 18.3105C16.6309 18.6523 16.8359 18.8672 17.168 18.8672C17.3242 18.8672 17.4805 18.8184 17.5977 18.7207L20.1172 16.6699C20.4004 16.4355 20.3906 16.0254 20.1074 15.791L17.6074 13.7793C17.4902 13.6719 17.334 13.6035 17.168 13.6035C16.8457 13.6035 16.6309 13.8281 16.6309 14.1699ZM17.0996 15.5273L15.5078 15.5273C14.7656 15.5273 14.3555 15.293 13.7988 14.6289L9.84375 9.99023C9.02344 9.04297 8.33984 8.71094 7.22656 8.71094L5.70312 8.71094C5.29297 8.71094 5.00977 8.98438 5.00977 9.36523C5.00977 9.73633 5.3125 10.0195 5.70312 10.0195L7.24609 10.0195C7.91016 10.0195 8.33984 10.2441 8.90625 10.918L12.8516 15.5566C13.6719 16.5039 14.3555 16.8359 15.4688 16.8359L17.0996 16.8359C17.4609 16.8359 17.7539 16.543 17.7539 16.1816C17.7539 15.8203 17.4609 15.5273 17.0996 15.5273Z"
                  fill-opacity="0.85"
                />
              </g>
              <g
                transform="scale(0.75) translate(0, 10)"
                :class="player.state.isShuffle ? 'visible' : ' invisible'"
              >
                <path
                  d="M25.4395 12.7246C25.4395 19.7266 19.7266 25.4395 12.7148 25.4395C5.71289 25.4395 0 19.7266 0 12.7246C0 5.71289 5.71289 0 12.7148 0C19.7266 0 25.4395 5.71289 25.4395 12.7246ZM16.7285 7.05078L16.7285 8.55469L15.5371 8.55469C14.3945 8.55469 13.6914 8.89648 12.8516 9.87305L11.2994 11.6952L9.78516 9.92188C8.94531 8.94531 8.24219 8.61328 7.09961 8.61328L5.54688 8.61328C5.11719 8.61328 4.82422 8.89648 4.82422 9.28711C4.82422 9.66797 5.13672 9.96094 5.54688 9.96094L7.12891 9.96094C7.80273 9.96094 8.23242 10.1855 8.81836 10.8789L10.4065 12.7433L8.80859 14.6191C8.22266 15.3125 7.79297 15.5371 7.10938 15.5371L5.53711 15.5371C5.12695 15.5371 4.81445 15.8301 4.81445 16.2109C4.81445 16.6016 5.10742 16.8848 5.53711 16.8848L7.08984 16.8848C8.23242 16.8848 8.93555 16.543 9.77539 15.5762L11.2994 13.7914L12.8613 15.625C13.7012 16.6016 14.4043 16.9434 15.5469 16.9434L16.7383 16.9434L16.7383 18.457C16.7383 18.7988 16.9531 19.0137 17.2852 19.0137C17.4512 19.0137 17.6074 18.9648 17.7344 18.8672L20.3223 16.7676C20.6055 16.5234 20.5957 16.1035 20.3125 15.8594L17.7441 13.7988C17.6172 13.6914 17.4609 13.623 17.2852 13.623C16.9629 13.623 16.7383 13.8477 16.7383 14.1992L16.7383 15.5859L15.5859 15.5859C14.8242 15.5859 14.4043 15.3516 13.8379 14.668L12.1944 12.7433L13.8281 10.8301C14.3945 10.1465 14.8145 9.91211 15.5762 9.91211L16.7285 9.91211L16.7285 11.2988C16.7285 11.6504 16.9531 11.875 17.2754 11.875C17.4512 11.875 17.6074 11.8066 17.7344 11.6992L20.293 9.63867C20.5859 9.39453 20.5957 8.97461 20.3125 8.73047L17.7246 6.63086C17.5977 6.5332 17.4414 6.48438 17.2754 6.48438C16.9434 6.48438 16.7285 6.69922 16.7285 7.05078Z"
                  fill-opacity="0.85"
                />
              </g>
            </svg>
          </button>

          <button
            class="text-zinc-200 hover:text-white text-xl"
            @click="player.playPrev"
            title="Previous"
          >
            <svg class="w-8 h-8 fill-white">
              <g transform="scale(0.55) translate(0, 20)">
                <path
                  d="M39.3555 17.3633L39.3555 1.60156C39.3555 0.507812 38.7109 0 37.9688 0C37.6367 0 37.3047 0.0976562 36.9727 0.283203L23.7402 8.04688C22.9102 8.52539 22.5781 8.90625 22.5781 9.48242C22.5781 10.0586 22.9102 10.4297 23.7402 10.9082L36.9727 18.6719C37.3047 18.8574 37.6367 18.9551 37.9688 18.9551C38.7109 18.9551 39.3555 18.457 39.3555 17.3633ZM22.6465 17.3633L22.6465 1.60156C22.6465 0.507812 22.002 0 21.2598 0C20.9277 0 20.5957 0.0976562 20.2637 0.283203L7.04102 8.04688C6.21094 8.52539 5.86914 8.90625 5.86914 9.48242C5.86914 10.0586 6.21094 10.4297 7.04102 10.9082L20.2637 18.6719C20.5957 18.8574 20.9277 18.9551 21.2598 18.9551C22.002 18.9551 22.6465 18.457 22.6465 17.3633ZM4.375 18.8965C5.41992 18.8965 5.9375 18.3789 5.9375 17.334L5.9375 1.61133C5.9375 0.576172 5.41992 0.0488281 4.375 0.0488281L1.5625 0.0488281C0.517578 0.0488281 0 0.527344 0 1.61133L0 17.334C0 18.3789 0.517578 18.8965 1.5625 18.8965Z"
                  fill-opacity="0.85"
                />
              </g>
            </svg>
          </button>

          <button
            class="bg-zinc-100 text-zinc-900 rounded-full h-8 w-8 flex items-center justify-center text-lg"
            @click="player.togglePlay"
            title="Play / Pause"
          >
            <span v-if="!player.state.isPlaying">
              <svg class="w-8 h-8 fill-black">
                <g
                  transform="scale(0.75) translate(11, 11)"
                  :class="player.state.isRepeatOne ? 'invisible' : ' visible'"
                >
                  <path
                    d="M2.25586 19.1699C2.25586 20.3223 2.92969 20.8594 3.7207 20.8594C4.0625 20.8594 4.42383 20.752 4.76562 20.5566L19.4531 11.9238C20.3613 11.3965 20.6934 11.0254 20.6934 10.4297C20.6934 9.82422 20.3613 9.45312 19.4531 8.92578L4.76562 0.292969C4.42383 0.0976562 4.0625 0 3.7207 0C2.92969 0 2.25586 0.527344 2.25586 1.67969Z"
                    fill-opacity="0.85"
                  />
                </g>
              </svg>
            </span>
            <span v-else>
              <svg class="w-8 h-8 fill-black">
                <g
                  transform="scale(0.75) translate(14, 11)"
                  :class="player.state.isRepeatOne ? 'invisible' : ' visible'"
                >
                  <path
                    d="M1.5625 20.5371L4.375 20.5371C5.41992 20.5371 5.9375 20.0195 5.9375 18.9746L5.9375 1.5625C5.9375 0.478516 5.41992 0 4.375 0L1.5625 0C0.517578 0 0 0.517578 0 1.5625L0 18.9746C0 20.0195 0.517578 20.5371 1.5625 20.5371ZM10.459 20.5371L13.2715 20.5371C14.3164 20.5371 14.834 20.0195 14.834 18.9746L14.834 1.5625C14.834 0.478516 14.3164 0 13.2715 0L10.459 0C9.41406 0 8.89648 0.517578 8.89648 1.5625L8.89648 18.9746C8.89648 20.0195 9.41406 20.5371 10.459 20.5371Z"
                    fill-opacity="0.85"
                  />
                </g>
              </svg>
            </span>
          </button>

          <button
            class="text-zinc-200 hover:text-white text-xl"
            @click="player.playNext"
            title="Next"
          >
            <svg class="w-8 h-8 fill-white">
              <g transform="scale(0.55) translate(0, 20)">
                <path
                  d="M0 17.3633C0 18.457 0.644531 18.9551 1.38672 18.9551C1.71875 18.9551 2.05078 18.8574 2.37305 18.6719L15.6055 10.9082C16.4355 10.4297 16.7676 10.0586 16.7676 9.48242C16.7676 8.90625 16.4355 8.52539 15.6055 8.04688L2.37305 0.283203C2.05078 0.0976562 1.71875 0 1.38672 0C0.644531 0 0 0.507812 0 1.60156ZM16.709 17.3633C16.709 18.457 17.3438 18.9551 18.0957 18.9551C18.418 18.9551 18.7598 18.8574 19.082 18.6719L32.3145 10.9082C33.1445 10.4297 33.4766 10.0586 33.4766 9.48242C33.4766 8.90625 33.1445 8.52539 32.3145 8.04688L19.082 0.283203C18.7598 0.0976562 18.418 0 18.0957 0C17.3438 0 16.709 0.507812 16.709 1.60156ZM34.9805 18.8965L37.793 18.8965C38.8281 18.8965 39.3555 18.3789 39.3555 17.334L39.3555 1.61133C39.3555 0.527344 38.8281 0.0488281 37.793 0.0488281L34.9805 0.0488281C33.9355 0.0488281 33.418 0.576172 33.418 1.61133L33.418 17.334C33.418 18.3789 33.9355 18.8965 34.9805 18.8965Z"
                  fill-opacity="0.85"
                />
              </g>
            </svg>
          </button>

          <button
            class="text-zinc-400 hover:text-white text-lg"
            @click="player.toggleRepeatOne"
            :title="player.state.isRepeatOne ? 'Repeat one on' : 'Repeat off'"
          >
            <svg class="w-8 h-8 fill-white">
              <g
                transform="scale(0.75) translate(0, 10)"
                :class="player.state.isRepeatOne ? 'invisible' : ' visible'"
              >
                <path
                  d="M12.7148 25.4395C19.7363 25.4395 25.4395 19.7461 25.4395 12.7246C25.4395 5.70312 19.7363 0 12.7148 0C5.69336 0 0 5.70312 0 12.7246C0 19.7461 5.69336 25.4395 12.7148 25.4395ZM12.7148 23.623C6.68945 23.623 1.81641 18.75 1.81641 12.7246C1.81641 6.69922 6.68945 1.82617 12.7148 1.82617C18.7402 1.82617 23.6133 6.69922 23.6133 12.7246C23.6133 18.75 18.7402 23.623 12.7148 23.623Z"
                  fill-opacity="0.85"
                />
                <path
                  d="M13.6035 6.5625L13.6035 11.2695C13.6035 11.6406 13.8379 11.875 14.1992 11.875C14.3555 11.875 14.5312 11.8262 14.668 11.6992L17.5 9.4043C17.8223 9.14062 17.8223 8.71094 17.5 8.4375L14.668 6.13281C14.5312 6.01562 14.3555 5.95703 14.1992 5.95703C13.8379 5.95703 13.6035 6.19141 13.6035 6.5625ZM14.5703 9.6582C14.9609 9.6582 15.293 9.32617 15.293 8.92578C15.293 8.53516 14.9609 8.20312 14.5703 8.20312L8.73047 8.20312C6.47461 8.20312 4.99023 9.57031 4.99023 11.6602L4.99023 12.373C4.99023 12.7832 5.32227 13.1055 5.73242 13.1055C6.14258 13.1055 6.47461 12.7832 6.47461 12.373L6.47461 11.7285C6.47461 10.4785 7.34375 9.6582 8.63281 9.6582ZM11.8457 18.9355L11.8457 14.2285C11.8457 13.8574 11.6113 13.623 11.25 13.623C11.0938 13.623 10.918 13.6719 10.7812 13.7988L7.94922 16.0938C7.62695 16.3574 7.62695 16.7871 7.94922 17.0605L10.7812 19.3652C10.918 19.4824 11.0938 19.541 11.25 19.541C11.6113 19.541 11.8457 19.3066 11.8457 18.9355ZM10.8789 15.8398C10.4883 15.8398 10.1562 16.1719 10.1562 16.5723C10.1562 16.9629 10.4883 17.2949 10.8789 17.2949L16.7188 17.2949C18.9746 17.2949 20.4492 15.9277 20.4492 13.8379L20.4492 13.125C20.4492 12.7148 20.127 12.3926 19.7168 12.3926C19.2969 12.3926 18.9746 12.7148 18.9746 13.125L18.9746 13.7695C18.9746 15.0098 18.1055 15.8398 16.8164 15.8398Z"
                  fill-opacity="0.85"
                />
              </g>
              <g
                transform="scale(0.75) translate(0, 10)"
                :class="player.state.isRepeatOne ? 'visible' : ' invisible'"
              >
                <path
                  d="M25.4395 12.7246C25.4395 19.7266 19.7266 25.4395 12.7148 25.4395C5.71289 25.4395 0 19.7266 0 12.7246C0 5.71289 5.71289 0 12.7148 0C19.7266 0 25.4395 5.71289 25.4395 12.7246ZM19.1309 13.1348L19.1309 13.7988C19.1309 15.0781 18.2422 15.9082 16.9336 15.9082L11.8359 15.9082L11.8359 14.2676C11.8359 13.877 11.6016 13.6426 11.2207 13.6426C11.0645 13.6426 10.8789 13.6914 10.7422 13.8184L7.8418 16.1719C7.50977 16.4453 7.50977 16.8848 7.8418 17.168L10.7422 19.5312C10.8789 19.668 11.0645 19.7168 11.2207 19.7168C11.6016 19.7168 11.8359 19.4727 11.8359 19.0918L11.8359 17.4121L16.8262 17.4121C19.1406 17.4121 20.6641 16.0156 20.6641 13.8672L20.6641 13.1348C20.6641 12.7148 20.3223 12.3828 19.9023 12.3828C19.4727 12.3828 19.1309 12.7148 19.1309 13.1348ZM13.6328 6.40625L13.6328 8.08594L8.64258 8.08594C6.32812 8.08594 4.80469 9.48242 4.80469 11.6309L4.80469 12.3633C4.80469 12.7832 5.14648 13.1152 5.55664 13.1152C5.99609 13.1152 6.33789 12.7832 6.33789 12.3633L6.33789 11.6992C6.33789 10.4199 7.2168 9.58008 8.53516 9.58008L13.6328 9.58008L13.6328 11.2305C13.6328 11.6211 13.8672 11.8555 14.248 11.8555C14.4043 11.8555 14.5898 11.7969 14.7266 11.6797L17.627 9.32617C17.959 9.05273 17.959 8.60352 17.627 8.33008L14.7266 5.9668C14.5898 5.83008 14.4043 5.78125 14.248 5.78125C13.8672 5.78125 13.6328 6.02539 13.6328 6.40625Z"
                  fill-opacity="0.85"
                />
              </g>
            </svg>
          </button>
        </div>
        <div class="flex items-center gap-3 w-full max-w-4xl px-4">
          <span class="text-sm text-zinc-400 w-12 text-right">
            {{ currentTimeLabel }}
          </span>
          <input
            type="range"
            min="0"
            max="100"
            v-model.number="progress"
            @input="onSeek"
            class="w-full range-slim"
            :style="{ '--pct': progress + '%' }"
          />
          <span class="text-sm text-zinc-400 w-12">
            {{ durationLabel }}
          </span>
        </div>
        <div class="flex items-center gap-4 w-full max-w-3xl px-4">
          <svg class="w-7 h-7 fill-white">
            <g transform="scale(0.55) translate(0, 19)">
              <path
                d="M28.4863 24.0882C28.8672 24.3616 29.3848 24.2542 29.6777 23.8245C31.8359 20.6116 33.2324 16.6858 33.2324 12.1253C33.2324 7.55495 31.8066 3.63894 29.6777 0.41628C29.3848-0.0231731 28.8672-0.120829 28.4863 0.152608C28.0859 0.426046 28.0273 0.943624 28.3301 1.38308C30.2734 4.3323 31.582 7.90651 31.582 12.1253C31.582 16.3342 30.2734 19.9182 28.3301 22.8577C28.0273 23.2971 28.0859 23.8147 28.4863 24.0882Z"
                fill-opacity="0.85"
              />
              <path
                d="M23.916 20.7385C24.3164 21.012 24.8145 20.9241 25.0977 20.5139C26.7188 18.3264 27.6855 15.2503 27.6855 12.1253C27.6855 8.9905 26.7285 5.8948 25.0977 3.73659C24.8145 3.32644 24.3164 3.22878 23.916 3.50222C23.5254 3.77566 23.457 4.2737 23.7695 4.72292C25.2051 6.71511 26.0156 9.36159 26.0156 12.1253C26.0156 14.8889 25.1855 17.5257 23.7695 19.5276C23.4668 19.9671 23.5254 20.4749 23.916 20.7385Z"
                fill-opacity="0.85"
              />
              <path
                d="M19.3945 17.4475C19.7656 17.7014 20.2734 17.6135 20.5566 17.2034C21.5234 15.9339 22.1289 14.0882 22.1289 12.1253C22.1289 10.1526 21.5234 8.31667 20.5566 7.03737C20.2734 6.62722 19.7656 6.54909 19.3945 6.803C18.9648 7.10573 18.8965 7.63308 19.2285 8.0823C20.0293 9.17605 20.459 10.5725 20.459 12.1253C20.459 13.6682 20.0195 15.055 19.2285 16.1682C18.9062 16.6175 18.9648 17.135 19.3945 17.4475Z"
                fill-opacity="0.85"
              />
              <path
                d="M13.4668 23.1018C14.2285 23.1018 14.7461 22.5452 14.7461 21.803L14.7461 2.51589C14.7461 1.7737 14.2285 1.16823 13.4473 1.16823C12.9102 1.16823 12.5391 1.40261 11.9824 1.92995L6.52344 7.10573C6.43555 7.19362 6.31836 7.23269 6.17188 7.23269L2.4707 7.23269C0.908203 7.23269 0 8.14089 0 9.80105L0 14.5276C0 16.178 0.908203 17.0862 2.4707 17.0862L6.17188 17.0862C6.31836 17.0862 6.43555 17.135 6.52344 17.2229L11.9824 22.3889C12.4902 22.8675 12.9297 23.1018 13.4668 23.1018Z"
                fill-opacity="0.85"
              />
            </g>
          </svg>
          <input
            type="range"
            min="0"
            max="1"
            step="0.01"
            v-model.number="volume"
            @input="onVolume"
            class="w-full range-slim"
            :style="{ '--pct': volume * 100 + '%' }"
          />
        </div>
        <button
          class="absolute top-4 right-4 text-zinc-400 hover:text-white"
          @click="expanded = false"
        >
          ✕
        </button>
      </div>

      <div
        class="relative z-10 grid md:grid-cols-2 gap-4 w-full max-w-6xl px-2 pb-2 xl:hidden"
      >
        <div
          class="bg-stone-950/70 border border-stone-800 rounded-2xl p-3 overflow-hidden"
        >
          <div class="flex items-center justify-between mb-2">
            <span class="font-semibold text-sm">History</span>
          </div>
          <div class="max-h-48 overflow-y-auto space-y-2 pr-1">
            <div
              v-for="(t, idx) in player.state.history"
              :key="'hx-' + t.id + '-' + idx"
              class="flex items-center justify-between gap-2 text-zinc-300 text-sm"
            >
              <p class="truncate">
                {{ t.title }}
              </p>
              <button
                class="text-[11px] text-zinc-400 hover:text-zinc-100"
                @click="player.playNow(t)"
              >
                Play
              </button>
            </div>
            <p
              v-if="!player.state.history.length"
              class="text-zinc-500 text-xs"
            >
              No history yet
            </p>
          </div>
        </div>

        <div
          class="bg-stone-950/70 border border-stone-800 rounded-2xl p-3 overflow-hidden"
        >
          <div class="flex items-center justify-between mb-2">
            <span class="font-semibold text-sm">Up Next</span>
            <button
              class="text-xs text-zinc-400 hover:text-zinc-100"
              @click="player.clearQueue"
            >
              Clear
            </button>
          </div>
          <div class="max-h-48 overflow-y-auto divide-y divide-stone-800">
            <div
              v-for="(t, idx) in player.state.queue"
              :key="'qx-' + t.id + '-' + idx"
              class="px-2 py-2 flex items-center gap-2 hover:bg-stone-800/70 cursor-pointer"
              :class="{
                'bg-stone-800/70': idx === player.state.currentIndex,
              }"
              @click="jumpTo(idx)"
            >
              <span class="text-[10px] text-zinc-500 w-4">
                {{ idx === player.state.currentIndex ? "▶" : idx + 1 }}
              </span>
              <div class="min-w-0">
                <p class="truncate text-sm">{{ t.title }}</p>
                <p class="truncate text-[11px] text-zinc-400">
                  {{ t.artist }} • {{ t.album }}
                </p>
              </div>
            </div>
            <p
              v-if="!player.state.queue.length"
              class="px-2 py-2 text-zinc-500 text-sm"
            >
              Queue is empty
            </p>
          </div>
        </div>

        <div
          v-if="currentTrack?.notes"
          class="md:col-span-2 bg-stone-950/70 border border-stone-800 rounded-2xl p-3 text-sm text-zinc-200"
        >
          <p class="font-semibold mb-2">Album notes</p>
          <p class="whitespace-pre-line leading-relaxed">
            {{ currentTrack.notes }}
          </p>
        </div>
      </div>
      <div
        class="hidden xl:flex flex-col gap-3 bg-stone-950/70 border border-stone-800 rounded-2xl p-3 h-full overflow-hidden relative z-10"
      >
        <details
          class="bg-stone-900/70 rounded-xl border border-stone-800"
          open
        >
          <summary class="px-3 py-2 cursor-pointer text-sm font-semibold">
            History
          </summary>
          <div
            class="max-h-40 overflow-y-auto space-y-2 px-3 py-2 no-scrollbar"
          >
            <div
              v-for="(t, idx) in player.state.history"
              :key="'hx-' + t.id + '-' + idx"
              class="flex items-center justify-between gap-2 text-zinc-300 text-sm"
            >
              <p class="truncate">
                {{ t.title }}
              </p>
              <button
                class="text-[11px] text-zinc-400 hover:text-zinc-100"
                @click="player.playNow(t)"
              >
                Play
              </button>
            </div>
            <p
              v-if="!player.state.history.length"
              class="text-zinc-500 text-xs"
            >
              No history yet
            </p>
          </div>
        </details>

        <details
          class="bg-stone-900/70 rounded-xl border border-stone-800"
          open
        >
          <summary class="px-3 py-2 cursor-pointer text-sm font-semibold">
            Up Next
          </summary>
          <div
            class="max-h-52 overflow-y-auto divide-y divide-stone-800 no-scrollbar"
          >
            <div
              v-for="(t, idx) in player.state.queue"
              :key="'qx-' + t.id + '-' + idx"
              class="px-3 py-2 flex items-center gap-2 hover:bg-stone-800/70 cursor-pointer"
              :class="{
                'bg-stone-800/70': idx === player.state.currentIndex,
              }"
              @click="jumpTo(idx)"
            >
              <span class="text-[10px] text-zinc-500 w-4">
                {{ idx === player.state.currentIndex ? "▶" : idx + 1 }}
              </span>
              <div class="min-w-0">
                <p class="truncate text-sm">{{ t.title }}</p>
                <p class="truncate text-[11px] text-zinc-400">
                  {{ t.artist }} • {{ t.album }}
                </p>
              </div>
            </div>
            <p
              v-if="!player.state.queue.length"
              class="px-3 py-2 text-zinc-500 text-sm"
            >
              Queue is empty
            </p>
          </div>
        </details>

        <details
          v-if="currentTrack?.notes"
          class="bg-stone-900/70 rounded-xl border border-stone-800"
          open
        >
          <summary class="px-3 py-2 cursor-pointer text-sm font-semibold">
            Album notes
          </summary>
          <div
            class="px-3 py-2 text-sm text-zinc-200 whitespace-pre-line no-scrollbar"
          >
            {{ currentTrack.notes }}
          </div>
        </details>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, watch, nextTick } from "vue";
import { usePlayer } from "../player/usePlayer";

const player = usePlayer();

const audioRef = ref(null);
const progress = ref(0);
const volume = ref(1);
const showQueue = ref(false);
const expanded = ref(false);
const audioBound = ref(false);

const currentTrack = computed(() => player.currentTrack.value);

const currentTimeLabel = ref("0:00");
const durationLabel = computed(
  () => currentTrack.value?.durationLabel || "--:--",
);

onMounted(() => {
  if (audioRef.value && !audioBound.value) {
    console.log("[playerbar] mounted audioRef exists");
    player.setAudioElement(audioRef.value);
    audioRef.value.volume = volume.value;
    audioBound.value = true;
  }
});

watch(
  () => player.state.queue.length,
  async (len) => {
    if (len > 0 && !audioBound.value) {
      await nextTick();
      if (audioRef.value) {
        console.log("[playerbar] queue non-empty, binding audioRef");
        player.setAudioElement(audioRef.value);
        audioRef.value.volume = volume.value;
        audioBound.value = true;
      } else {
        console.warn("[playerbar] queue non-empty but audioRef missing");
      }
    }
  },
);

watch(
  () => player.currentTrack.value,
  () => {
    progress.value = 0;
    currentTimeLabel.value = "0:00";
  },
);

function onTimeUpdate(e) {
  const el = e.target;
  if (!el.duration || isNaN(el.duration)) return;
  const ratio = el.currentTime / el.duration;
  progress.value = Math.floor(ratio * 100);

  const minutes = Math.floor(el.currentTime / 60);
  const seconds = Math.floor(el.currentTime % 60)
    .toString()
    .padStart(2, "0");
  currentTimeLabel.value = `${minutes}:${seconds}`;
}

function onSeek() {
  const el = audioRef.value;
  if (!el || !el.duration || isNaN(el.duration)) return;
  const t = (progress.value / 100) * el.duration;
  el.currentTime = t;
}

function onVolume() {
  if (!audioRef.value) return;
  audioRef.value.volume = volume.value;
}

function jumpTo(idx) {
  if (idx < 0 || idx >= player.state.queue.length) return;
  const track = player.state.queue[idx];
  player.playNow(track, player.state.queue);
}

watch(expanded, async (val) => {
  if (val && !audioBound.value && audioRef.value) {
    await nextTick();
    player.setAudioElement(audioRef.value);
    audioRef.value.volume = volume.value;
    audioBound.value = true;
  }
});
</script>

<style scoped>
.range-slim {
  height: 6px;
  appearance: none;
  background: linear-gradient(
    to right,
    #ffffff 0%,
    #c6c6c6 var(--pct, 0%),
    #4b5563 var(--pct, 0%),
    #4b5563 100%
  );
  border-radius: 20px;
  transition: all 0.15s ease;
}
.range-slim:hover {
  height: 10px;
}
.range-slim::-webkit-slider-thumb {
  appearance: none;
  width: 0;
  height: 0;
  background: transparent;
  border: none;
}
.range-slim::-moz-range-thumb {
  width: 0;
  height: 0;
  border: none;
  background: transparent;
}

.no-scrollbar {
  scrollbar-width: none;
}
.no-scrollbar::-webkit-scrollbar {
  width: 0;
  height: 0;
}

.smoke-layer {
  background:
    radial-gradient(
      circle at 20% 20%,
      rgba(255, 255, 255, 0.12),
      transparent 35%
    ),
    radial-gradient(
      circle at 80% 10%,
      rgba(255, 255, 255, 0.1),
      transparent 30%
    ),
    radial-gradient(
      circle at 50% 80%,
      rgba(255, 255, 255, 0.08),
      transparent 25%
    ),
    linear-gradient(120deg, rgba(255, 255, 255, 0.07), rgba(255, 255, 255, 0));
  animation: drift 14s ease-in-out infinite alternate;
}

.smoke-plume {
  background: radial-gradient(
    circle,
    rgba(255, 255, 255, 0.22) 0%,
    transparent 55%
  );
  mix-blend-mode: screen;
  opacity: 0.25;
  filter: blur(30px);
}

.smoke-plume-1 {
  animation: plume1 16s ease-in-out infinite;
}
.smoke-plume-2 {
  animation: plume2 18s ease-in-out infinite;
}
.smoke-plume-3 {
  animation: plume3 22s ease-in-out infinite;
}

@keyframes drift {
  0% {
    transform: translate3d(-2%, -1%, 0) scale(1);
    filter: blur(22px);
  }
  50% {
    transform: translate3d(2%, 2%, 0) scale(1.05);
    filter: blur(28px);
  }
  100% {
    transform: translate3d(-1%, 3%, 0) scale(1.02);
    filter: blur(24px);
  }
}

@keyframes plume1 {
  0% {
    transform: translate3d(-10%, 10%, 0) scale(1.2);
  }
  50% {
    transform: translate3d(8%, -6%, 0) scale(1.4);
  }
  100% {
    transform: translate3d(-6%, -12%, 0) scale(1.25);
  }
}

@keyframes plume2 {
  0% {
    transform: translate3d(12%, -14%, 0) scale(1);
  }
  50% {
    transform: translate3d(-8%, 12%, 0) scale(1.3);
  }
  100% {
    transform: translate3d(10%, 16%, 0) scale(1.1);
  }
}

@keyframes plume3 {
  0% {
    transform: translate3d(0%, 18%, 0) scale(1.05);
  }
  50% {
    transform: translate3d(-12%, -8%, 0) scale(1.3);
  }
  100% {
    transform: translate3d(14%, -2%, 0) scale(1.15);
  }
}
</style>
